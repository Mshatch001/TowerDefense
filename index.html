<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arcane Forest Defense</title>
  <style>
    :root {
      color-scheme: dark;
      --panel: #0f1b22;
      --accent: #4dd0e1;
      --text: #e3f2fd;
    }
    body {
      margin: 0;
      background: #0b141a;
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      display: grid;
      min-height: 100vh;
      place-items: center;
    }
    .frame {
      background: var(--panel);
      border: 1px solid #1f2f38;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
    }
    h1 {
      margin: 0 0 12px;
      font-size: 20px;
      letter-spacing: 0.04em;
      text-align: center;
    }
    #gameCanvas {
      background: #0f2d1e;
      border-radius: 12px;
      display: block;
    }
    .status {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #b6c7d3;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(77, 208, 225, 0.12);
      color: var(--text);
      border: 1px solid rgba(77, 208, 225, 0.4);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="frame">
    <h1>Arcane Forest Defense</h1>
    <canvas id="gameCanvas" width="800" height="540" aria-label="Tower defense canvas"></canvas>
    <div class="status">
      <span id="asset-counter">Loading assets 0/0â€¦</span>
      <span id="game-status" class="pill">Preparing</span>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const assetCounter = document.getElementById("asset-counter");
    const gameStatus = document.getElementById("game-status");

    const spriteManifest = [
      { key: "background", src: "assets/images/map_mushroom_forest.svg" },
      { key: "archer", src: "assets/images/archer.svg" },
      { key: "mage", src: "assets/images/mage.svg" },
      { key: "enemyGoblin", src: "assets/images/Goblin.svg" },
      { key: "enemyOrc", src: "assets/images/Orc.svg" },
      { key: "enemyTroll", src: "assets/images/Troll.svg" },
      { key: "enemySonic", src: "assets/images/Sonic.svg" },
    ];

    const loadedSprites = {};
    let assetsLoaded = 0;

    function updateAssetCounter() {
      assetCounter.textContent = `Loading assets ${assetsLoaded}/${spriteManifest.length}`;
    }

    function loadSprite({ key, src }) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          loadedSprites[key] = img;
          assetsLoaded += 1;
          updateAssetCounter();
          resolve();
        };
        img.onerror = () => {
          console.error(`Failed to load ${src}`);
          reject(new Error(`Failed to load ${src}`));
        };
        img.src = src;
      });
    }

    function loadAllSprites() {
      updateAssetCounter();
      return Promise.all(spriteManifest.map(loadSprite));
    }

    // Background: scale to fit canvas while preserving aspect ratio
    function drawBackground() {
      const bg = loadedSprites.background;
      if (bg && bg.complete && bg.naturalWidth > 0) {
        const canvasAspect = canvas.width / canvas.height;
        const imgAspect = bg.naturalWidth / bg.naturalHeight;

        let drawWidth, drawHeight, offsetX, offsetY;
        if (imgAspect > canvasAspect) {
          // Image is wider than canvas
          drawHeight = canvas.height;
          drawWidth = bg.naturalWidth * (drawHeight / bg.naturalHeight);
          offsetX = (canvas.width - drawWidth) / 2;
          offsetY = 0;
        } else {
          // Image is taller than canvas
          drawWidth = canvas.width;
          drawHeight = bg.naturalHeight * (drawWidth / bg.naturalWidth);
          offsetX = 0;
          offsetY = (canvas.height - drawHeight) / 2;
        }

        ctx.drawImage(bg, offsetX, offsetY, drawWidth, drawHeight);
      } else {
        ctx.fillStyle = "#0f2d1e";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    // Helper: draw any sprite at a normalized size
    function drawSpriteNormalized(sprite, x, y, maxSize) {
      if (!sprite || !sprite.complete || sprite.naturalWidth === 0) return;

      const w = sprite.naturalWidth;
      const h = sprite.naturalHeight;
      const scale = maxSize / Math.max(w, h);

      const drawWidth = w * scale;
      const drawHeight = h * scale;

      ctx.drawImage(
        sprite,
        x - drawWidth / 2,
        y - drawHeight / 2,
        drawWidth,
        drawHeight
      );
    }

    function drawTowers() {
      const TOWER_SIZE = 96; // target size in pixels
      const towers = [
        { sprite: loadedSprites.archer, x: 120, y: 360 },
        { sprite: loadedSprites.mage, x: 620, y: 360 },
      ];
      towers.forEach(({ sprite, x, y }) => {
        drawSpriteNormalized(sprite, x, y, TOWER_SIZE);
      });
    }

    function drawEnemies() {
      const ENEMY_SIZE = 96; // target size in pixels
      const enemies = [
        { sprite: loadedSprites.enemyGoblin, x: 180, y: 220 },
        { sprite: loadedSprites.enemyOrc, x: 330, y: 180 },
        { sprite: loadedSprites.enemyTroll, x: 480, y: 230 },
        { sprite: loadedSprites.enemySonic, x: 610, y: 190 },
      ];
      enemies.forEach(({ sprite, x, y }) => {
        drawSpriteNormalized(sprite, x, y, ENEMY_SIZE);
      });
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground();
      drawTowers();
      drawEnemies();
      requestAnimationFrame(render);
    }

    function startGame() {
      gameStatus.textContent = "Ready";
      gameStatus.style.background = "rgba(76, 175, 80, 0.14)";
      gameStatus.style.color = "#c8e6c9";
      requestAnimationFrame(render);
    }

    loadAllSprites()
      .then(() => startGame())
      .catch((error) => {
        gameStatus.textContent = "Asset error";
        gameStatus.style.background = "rgba(244, 67, 54, 0.14)";
        gameStatus.style.color = "#ffcdd2";
        console.error(error);
      });
  </script>
</body>
</html>
